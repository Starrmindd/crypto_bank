<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banking DApp</title>
    <script src="https://cdn.jsdelivr.net/npm/web3/dist/web3.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="https://via.placeholder.com/100" alt="Profile">
            <h2 id="userAddress">Hello!</h2>
            <button onclick="connectMetaMask()" class="btn custom-btn">
                <i class="fa-solid fa-wallet"></i> Connect Wallet
            </button>
        </div>
        
        <div class="summary">
            <div class="balance">
                <h1 id="ethBalance">0.00 ETH</h1>
				<p id="userID">User ID: -</p>

                <p>Available balance</p>
            </div>
        </div>

        <div class="menu">
            <div onclick="depositFunds()"><i class="fa-solid fa-arrow-down"></i><p>Deposit</p></div>
            <div onclick="openModal('withdrawModal')"><i class="fa-solid fa-arrow-up"></i><p>Withdraw</p></div>
            <div onclick="openModal('transferModal')"><i class="fa-solid fa-paper-plane"></i><p>Transfer</p></div>
        </div>
           <!-- Withdraw Modal -->
    <div id="withdrawModal" class="modal">
      <div class="modal-content">
          <span class="close" onclick="closeModal('withdrawModal')">&times;</span>
          <h2>Withdraw ETH</h2>
          <input type="number" id="withdrawAmount" placeholder="Enter amount (ETH)">
          <button onclick="withdrawFunds()">Withdraw</button>
      </div>
  </div>

  <!-- Transfer Modal -->
  <div id="transferModal" class="modal">
      <div class="modal-content">
          <span class="close" onclick="closeModal('transferModal')">&times;</span>
          <h2>Transfer Funds</h2>
          <input type="text" id="transferAddress" placeholder="Recipient Address">
          <input type="number" id="transferAmount" placeholder="Enter amount (ETH)">
          <button onclick="transferFunds()">Transfer</button>
      </div>
  </div>




        
        <div class="transactions">
            <h3>Transaction History</h3>
            <div id="transactionList"></div>
            <button id="seeMoreBtn" onclick="loadMoreTransactions()" class="btn btn-primary" style="display:none; margin-top: 10px;">See More</button>
            <button id="seeLessBtn" onclick="collapseTransactions()" class="btn btn-secondary" style="display:none; margin-top: 10px;">See Less</button>
        </div>
        <div class="footer">
          <i class="fa-solid fa-home"></i>
          <i class="fa-solid fa-chart-line"></i>
          <i class="fa-solid fa-wallet"></i>
          <i class="fa-solid fa-cog"></i>
      </div>
  </div>
    </div>

    
    <script>
        const contractAddress = "0x2B13Fdb0AB49D0997b5462e8B8Dd55Ea9dFB5486";
        const contractABI = [
	{
		"inputs": [],
		"name": "deposit",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "ECDSAInvalidSignature",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "length",
				"type": "uint256"
			}
		],
		"name": "ECDSAInvalidSignatureLength",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "bytes32",
				"name": "s",
				"type": "bytes32"
			}
		],
		"name": "ECDSAInvalidSignatureS",
		"type": "error"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "uniqueID",
				"type": "string"
			},
			{
				"internalType": "bytes32",
				"name": "hash",
				"type": "bytes32"
			},
			{
				"internalType": "bytes",
				"name": "signature",
				"type": "bytes"
			}
		],
		"name": "login",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "user",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "bool",
				"name": "success",
				"type": "bool"
			}
		],
		"name": "LoginAttempt",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "miner",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "nonce",
				"type": "uint256"
			}
		],
		"name": "ProofOfWorkValidated",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "_username",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_NIN",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_BVN",
				"type": "string"
			}
		],
		"name": "registerUser",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "sender",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "recipient",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "bytes32",
				"name": "hash",
				"type": "bytes32"
			}
		],
		"name": "TransactionRecorded",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "recipientID",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			},
			{
				"internalType": "bytes",
				"name": "signature",
				"type": "bytes"
			},
			{
				"internalType": "uint256",
				"name": "nonce",
				"type": "uint256"
			}
		],
		"name": "transferFunds",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "user",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "uniqueID",
				"type": "string"
			}
		],
		"name": "UserRegistered",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			}
		],
		"name": "withdraw",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "allTransactions",
		"outputs": [
			{
				"internalType": "address",
				"name": "sender",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "recipient",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			},
			{
				"internalType": "bytes",
				"name": "signature",
				"type": "bytes"
			},
			{
				"internalType": "bytes32",
				"name": "hash",
				"type": "bytes32"
			},
			{
				"internalType": "uint256",
				"name": "nonce",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "balances",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"name": "idToAddress",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "users",
		"outputs": [
			{
				"internalType": "string",
				"name": "username",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "NIN",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "BVN",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "uniqueID",
				"type": "string"
			},
			{
				"internalType": "bool",
				"name": "isRegistered",
				"type": "bool"
			},
			{
				"internalType": "address",
				"name": "userAddress",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "userTransactions",
		"outputs": [
			{
				"internalType": "address",
				"name": "sender",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "recipient",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "amount",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "timestamp",
				"type": "uint256"
			},
			{
				"internalType": "bytes",
				"name": "signature",
				"type": "bytes"
			},
			{
				"internalType": "bytes32",
				"name": "hash",
				"type": "bytes32"
			},
			{
				"internalType": "uint256",
				"name": "nonce",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
]

        let web3;
        let contract;
        let userAccount;
        let transactions = [];
        let visibleTransactions = 4;

		async function connectMetaMask() {
    if (window.ethereum) {
        web3 = new Web3(window.ethereum);
        try {
            const accounts = await ethereum.request({ method: "eth_requestAccounts" });
            userAccount = accounts[0];
            document.getElementById("userAddress").innerText = `Hello, ${userAccount.slice(0, 5)}...${userAccount.slice(-4)}!`;
            contract = new web3.eth.Contract(contractABI, contractAddress);

            // Fetch and display user ID
            const userData = await contract.methods.users(userAccount).call();
            if (userData.isRegistered) { // Ensure user is registered
                const userID = userData.uniqueID;
                document.getElementById("userID").innerText = `User ID: ${userID}`;
            } else {
                document.getElementById("userID").innerText = `User ID: Not Registered`;
            }

            getBalance();
            getTransactionHistory();
        } catch (error) {
            console.error("User denied account access", error);
        }
    } else {
        alert("MetaMask not detected. Please install MetaMask.");
    }
}



contract.events.UserRegistered()
    .on("data", async function(event) {
        if (event.returnValues.user.toLowerCase() === userAccount.toLowerCase()) {
            document.getElementById("userID").innerText = `User ID: ${event.returnValues.uniqueID}`;
        }
    })
    .on("error", console.error);

	async function registerUser(username, NIN, BVN) {
    try {
        await contract.methods.registerUser(username, NIN, BVN).send({ from: userAccount });
        alert("Registration successful!");
        
        // Fetch and update the user ID
        const userData = await contract.methods.users(userAccount).call();
        document.getElementById("userID").innerText = `User ID: ${userData.uniqueID}`;
    } catch (error) {
        console.error("Registration failed", error);
    }
}


		
		
        async function getBalance() {
    if (!userAccount || !contract) return;
    try {
        const balance = await web3.eth.getBalance(userAccount);
        const formattedBalance = parseFloat(web3.utils.fromWei(balance, "ether")).toFixed(4); // Convert & format to 4 decimal places
        document.getElementById("ethBalance").innerText = `${formattedBalance} ETH`;
    } catch (error) {
        console.error("❌ Failed to fetch balance:", error);
    }
}

async function withdrawFunds() {
            const amount = document.getElementById("withdrawAmount").value;
            if (!amount || amount <= 0) return alert("Invalid amount!");

            try {
                const contractBalance = await contract.methods.balances(userAccount).call();
                if (parseFloat(web3.utils.fromWei(contractBalance, "ether")) < amount) {
                    alert("Insufficient balance in contract. Deposit first!");
                    return;
                }

                await contract.methods.withdraw(web3.utils.toWei(amount, "ether")).send({ from: userAccount });
                alert(`Withdrawn ${amount} ETH`);
                getBalance();
                getTransactionHistory();
                closeModal('withdrawModal');
            } catch (error) {
                console.error("Withdrawal failed", error);
            }
        }

        async function transferFunds() {
            const recipient = document.getElementById("transferAddress").value;
            const amount = document.getElementById("transferAmount").value;
            if (!recipient || amount <= 0) return alert("Invalid recipient or amount!");

            try {
                const senderBalance = await contract.methods.balances(userAccount).call();
                if (parseFloat(web3.utils.fromWei(senderBalance, "ether")) < amount) {
                    alert("Insufficient balance in contract. Deposit first!");
                    return;
                }

                await contract.methods.transferFunds(recipient, web3.utils.toWei(amount, "ether")).send({ from: userAccount });
                alert(`Transferred ${amount} ETH to ${recipient}`);
                getBalance();
                getTransactionHistory();
                closeModal('transferModal');
            } catch (error) {
                console.error("Transfer failed", error);
            }
        }


        async function depositFunds() {
            if (!userAccount || !contract) return;
            const amount = prompt("Enter amount to deposit in ETH:");
            if (!amount || isNaN(amount)) return;
            const weiAmount = web3.utils.toWei(amount, "ether");

            try {
                await contract.methods.deposit().send({ from: userAccount, value: weiAmount });
                getBalance();
                getTransactionHistory();
            } catch (error) {
                console.error("❌ Deposit failed:", error);
            }
        }
 
async function getTransactionHistory() {
    if (!userAccount || !contract) return;
    try {
        transactions = await contract.methods.getTransactions(userAccount).call();
        transactions.sort((a, b) => Number(b.timestamp) - Number(a.timestamp)); // Sort latest first
        updateTransactionUI();
    } catch (error) {
        console.error("❌ Failed to fetch transactions:", error);
    }
}

function updateTransactionUI() {
    const transactionList = document.getElementById("transactionList");
    transactionList.innerHTML = "";
    
    // Ensure we don't show more transactions than available
    const displayedTransactions = transactions.slice(0, Math.min(visibleTransactions, transactions.length));

    displayedTransactions.forEach(tx => {
        let amountInEth = web3.utils.fromWei(tx.amount.toString(), "ether");
        let formattedTimestamp = new Date(Number(tx.timestamp) * 1000).toLocaleString();

        // Assign colors based on transaction type
        let color;
        if (tx.txType === "Deposit") {
            color = "#1dd81d";
        } else if (tx.txType === "Withdraw") {
            color = "blue";
        } else if (tx.txType === "Transfer") {
            color = "red";
        } else {
            color = "black";
        }

        transactionList.innerHTML += `
            <div class="transaction" style="border-bottom: 1px solid #ddd; padding: 10px;">
                <p><strong>${tx.txType}</strong> to ${tx.recipient.slice(0, 5)}...${tx.recipient.slice(-4)}</p>
                <p style="font-weight: bold; color: ${color};">${amountInEth} ETH</p>
                <small>${formattedTimestamp}</small>
            </div>
        `;
    });

    // Show or hide buttons based on transaction count
    document.getElementById("seeMoreBtn").style.display = visibleTransactions < transactions.length ? "block" : "none";
    document.getElementById("seeLessBtn").style.display = visibleTransactions > 4 ? "block" : "none";
}

function loadMoreTransactions() {
    visibleTransactions += 4; // Show 4 more transactions
    updateTransactionUI();
}

function collapseTransactions() {
    visibleTransactions = 4; // Reset back to 4 transactions
    updateTransactionUI();
}


        function openModal(id) { document.getElementById(id).style.display = "block"; }
        function closeModal(id) { document.getElementById(id).style.display = "none"; }

    </script>
</body>
</html>
